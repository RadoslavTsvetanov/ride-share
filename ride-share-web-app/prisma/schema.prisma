// schema.prisma

datasource db {
  provider = "postgresql" // or mysql/sqlite
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model UserDetails {
  id       String @id @default(cuid())
  email    String @unique
  password String 
  name String? @default("")
  // Relations
  passenger Passenger?
  driver    Driver?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Passenger {
  id           String       @id @default(cuid())
  userDetails  UserDetails  @relation(fields: [userDetailsId], references: [id])
  userDetailsId String      @unique

  rideRequests RideRequest[]
  rides        Ride[] // rides passenger participates in

  reviewsWritten  Review[] @relation("PassengerReviewsWritten")
  reviewsReceived Review[] @relation("PassengerReviewsReceived")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Ride Ride[] @relation("RidePassengers")
}

model Driver {
  id           String       @id @default(cuid())
  userDetails  UserDetails  @relation(fields: [userDetailsId], references: [id])
  userDetailsId String      @unique

  description String @default("")

  rideOpportunities RideOpportunity[]
  rides             Ride[] // rides created from their opportunities

  reviewsWritten  Review[] @relation("DriverReviewsWritten")
  reviewsReceived Review[] @relation("DriverReviewsReceived")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RideRequest {
  id          String    @id @default(cuid())
  passenger   Passenger @relation(fields: [passengerId], references: [id])
  passengerId String

  startLat Float
  startLng Float
  endLat   Float
  endLng   Float
  arrivalTime String 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RideOpportunity {
  id       String   @id @default(cuid())
  driver   Driver   @relation(fields: [driverId], references: [id])
  driverId String
  arrivalTime String 
  


  startLat Float
  startLng Float
  endLat   Float
  endLng   Float

  stops    Json // array of intermediary stops [{lat, lng}, ...]

  rides    Ride[] // rides booked based on this opportunity

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Ride {
  id                  String           @id @default(cuid())
  rideOpportunity     RideOpportunity  @relation(fields: [rideOpportunityId], references: [id])
  rideOpportunityId   String

  passengers          Passenger[]      @relation("RidePassengers") // multiple passengers can join

  reviews             Review[]         @relation("RideReviews") // reviews for this ride

  startLat Float
  startLng Float
  endLat   Float
  endLng   Float

  stops    Json // optional, can inherit from opportunity or override

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Passenger Passenger[]

  Driver Driver[]
}

model Review {
  id        String @id @default(cuid())
  rating    Int
  comment   String?

  // Relationships
  passengerAuthor Passenger? @relation("PassengerReviewsWritten", fields: [passengerAuthorId], references: [id])
  passengerAuthorId String?

  passengerRecipient Passenger? @relation("PassengerReviewsReceived", fields: [passengerRecipientId], references: [id])
  passengerRecipientId String?

  driverAuthor Driver? @relation("DriverReviewsWritten", fields: [driverAuthorId], references: [id])
  driverAuthorId String?

  driverRecipient Driver? @relation("DriverReviewsReceived", fields: [driverRecipientId], references: [id])
  driverRecipientId String?

  ride          Ride? @relation("RideReviews", fields: [rideId], references: [id])
  rideId        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
